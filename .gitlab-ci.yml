# image: mcr.microsoft.com/dotnet/core/sdk:3.1
#
# dotnet-package:
#   tags: [ "runner:main" ]
#   script:
#     - echo "Installing dependencies"
#     - apt-get update
#     - apt-get install unzip
#     - bash ./dotnet/build-packages.sh
#   artifacts:
#     expire_in: 1 weeks
#     paths:
#       - package
#
# java-package:
#   tags: [ "runner:main" ]
#   script:
#     - echo "Installing dependencies"
#     - apt-get update
#     - apt-get install unzip
#     - bash ./java/build-packages.sh
#   artifacts:
#     expire_in: 1 weeks
#     paths:
#       - package

# build-agent-process-manager-module:
#   tags: ["arch:amd64"]
#   image: registry.ddbuild.io/images/mirror/dotnet/framework:sdk-4.8-windowsservercore-ltsc2022
#   script:
#     - $env:path
#     - msbuild node/AgentProcessManager/AgentProcessManager.sln /p:Configuration=Release /p:Platform=x64
#     - msbuild node/AgentProcessManager/AgentProcessManager.sln /p:Configuration=Release /p:Platform=x86
#   artifacts:
#     paths:
#       - node/AgentProcessManager/x64/Release/AgentProcessManager.dll
#       - node/AgentProcessManager/Release/AgentProcessManager.dll

build-agent-process-manager-module:
  tags: ["runner:windows-docker", "windowsversion:2022"]
  # image: registry.ddbuild.io/images/mirror/dotnet/framework:sdk-4.8-windowsservercore-ltsc2022
  script:
    - $env:Path
    - |
      `
      # Install VS Build Tools
      && curl -fSLo vs_BuildTools.exe https://aka.ms/vs/17/release/vs_BuildTools.exe `
      && start /w vs_BuildTools ^ `
          --installPath "%ProgramFiles(x86)%\Microsoft Visual Studio\2022\BuildTools" ^ `
          --add Microsoft.Component.ClickOnce.MSBuild ^ `
          --add Microsoft.Net.Component.4.8.SDK ^ `
          --add Microsoft.NetCore.Component.Runtime.6.0 ^ `
          --add Microsoft.NetCore.Component.Runtime.7.0 ^ `
          --add Microsoft.NetCore.Component.Runtime.8.0 ^ `
          --add Microsoft.NetCore.Component.SDK ^ `
          --add Microsoft.VisualStudio.Component.NuGet.BuildTools ^ `
          --add Microsoft.VisualStudio.Component.WebDeploy ^ `
          --add Microsoft.VisualStudio.Web.BuildTools.ComponentGroup ^ `
          --add Microsoft.VisualStudio.Workload.MSBuildTools ^ `
          --quiet --norestart --nocache --wait `
      && powershell -Command "if ($err = dir $Env:TEMP -Filter dd_setup_*_errors.log | where Length -gt 0 | Get-Content) { throw $err }" `
      && del vs_BuildTools.exe `
    - $env:Path
    - |
      powershell setx /M PATH $(${Env:PATH} `
      + \";${Env:ProgramFiles(x86)}\Microsoft Visual Studio\2022\BuildTools\MSBuild\Current\Bin\amd64\" `
    - $env:Path
    - msbuild node/AgentProcessManager/AgentProcessManager.sln /p:Configuration=Release /p:Platform=x64
    - msbuild node/AgentProcessManager/AgentProcessManager.sln /p:Configuration=Release /p:Platform=x86
  artifacts:
    paths:
      - node/AgentProcessManager/x64/Release/AgentProcessManager.dll
      - node/AgentProcessManager/Release/AgentProcessManager.dll

build-process-manager:
  tags: ["arch:amd64"]
  image: registry.ddbuild.io/images/mirror/rust:1.73
  script:
    - apt update
    - apt install -y mingw-w64
    - rustup target add x86_64-pc-windows-gnu
    - cargo build --manifest-path=node/process_manager/Cargo.toml --release --target=x86_64-pc-windows-gnu
  artifacts:
    paths:
      - node/process_manager/target/x86_64-pc-windows-gnu/release/process_manager.exe

pack-nuget-package:
  tags: ["arch:amd64"]
  image: registry.ddbuild.io/images/mirror/dotnet:sdk-8.0.100-1
  needs:
    - build-agent-process-manager-module
    - build-process-manager
  script:
    - echo "Installing dependencies"
    - apt update
    - apt install -y unzip rsync
    - curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
    - export NVM_DIR="$HOME/.nvm"
    - '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"'
    - nvm install 20.11.0
    - cp node/AgentProcessManager/x64/Release/AgentProcessManager.dll node/AgentProcessManager/Release/AgentProcessManager.dll node/process_manager/target/x86_64-pc-windows-gnu/release/process_manager.exe node/src
    - bash ./node/build-packages.sh

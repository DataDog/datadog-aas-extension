image: mcr.microsoft.com/dotnet/core/sdk:3.1

stages:
  - dependencies
  - download
  - package

variables:
  AGENT_DOWNLOAD_URL: "http://s3.amazonaws.com/ddagent-windows-unstable/cf-windows-7.17.0-rc.4.git.35.7bd7ba0-1-x86_64.zip"
  TRACER_DOWNLOAD_URL: "https://github.com/DataDog/dd-trace-dotnet/archive/v1.11.1-prerelease.zip"
  TRACER_CONTENT_DIR: $CI_PROJECT_DIR/content/Tracer
  AGENT_CONTENT_DIR: $CI_PROJECT_DIR/content/Agent
  NUSPEC_FILE: $CI_PROJECT_DIR/Datadog.AzureAppServices.nuspec

install-dependencies:
  tags: [ "runner:main", "size:2xlarge" ]
  stage: dependencies
  script:
    - dotnet --info
    - echo "Installing dependencies"
    - apt-get update
    - apt-get install unzip

download-agent:
  tags: [ "runner:main", "size:2xlarge" ]
  stage: download
  script:
    - echo "Downloading agent from ${AGENT_DOWNLOAD_URL}"
    - mkdir agent-download
    - cd agent-download
    - wget -O agent.zip $AGENT_DOWNLOAD_URL
    - unzip agent.zip -d extract
    - ls
  artifacts:
    paths:
      - agent-download/extract

download-tracer:
  tags: [ "runner:main", "size:2xlarge" ]
  stage: download
  script:
    - echo "Downloading tracer from ${TRACER_DOWNLOAD_URL}"
    - mkdir tracer-download
    - cd tracer-download
    - wget -O tracer.zip $TRACER_DOWNLOAD_URL
    - unzip tracer.zip -d extract
    - ls
  artifacts:
    paths:
      - tracer-download/extract

move-extracts:
  tags: [ "runner:main", "size:2xlarge" ]
  stage: package
  script:
    - echo "Moving agent executables and tracer binaries"
    - mv -v tracer-download/extract/* $TRACER_CONTENT_DIR
    - mv download-agent/extract/bin/agent/dogstatsd.exe $AGENT_CONTENT_DIR/dogstatsd.exe
    - mv download-agent/extract/bin/agent/trace-agent.exe $AGENT_CONTENT_DIR/datadog-trace-agent.exe

nuget-pack:
  tags: [ "runner:main", "size:2xlarge" ]
  stage: package
  script:
    - dotnet nuget
    - ls
    - echo "dotnet nuget pack Datadog.AzureAppServices.nuspec"
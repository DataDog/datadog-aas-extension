name: Update extension on AAS, triggered by dd-trace-dotnet nightly build

on:
  workflow_dispatch:
    inputs:
      sha:
        description: 'Hash commit of dd-trace-dotnet build'
        required: true
  repository_dispatch:
    types: [dd-trace-dotnet-nightly]

jobs:
  update_extension:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

    steps:
      - name: "Set Variables"
        id: "set_variables"
        run: |
          if [[ ! -z "${{ github.event.inputs.sha }}" ]]; then
            echo "::set-output name=sha::${{ github.event.inputs.sha }}"
          else
            echo "Error. Hash commit wasn't provided in input."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v2

      - name: "Modify build-packages-dev"
        id: "versions"
        run: |
          build=${{ github.run_id }}
          build="${build:1}"

          DEV_VERSION=0.2.$(echo $build | bc)
          echo New dev version is $DEV_VERSION
          echo "::set-output name=dev_version::$DEV_VERSION"

      - uses: actions/setup-dotnet@v1
        with:
          dotnet-version: '6.0.100'

      - name: "Build nuget package"
        run: |
          sha=${{ steps.set_variables.outputs.sha }}
          dev_version=${{steps.versions.outputs.dev_version}}

          bash dotnet/build-packages-dev.sh $dev_version $sha

      - name: "Upload dev nuget"
        run: |
          dev_version=${{steps.versions.outputs.dev_version}}
          bash dotnet/upload-dev-nuget.sh $dev_version ${{ secrets.AZDO_PAT }}

      - name: Azure CLI script
        uses: azure/CLI@v1
        with:
          inlineScript: |
            resourceGroupName="apm-aas-junkyard"
            aasName="dd-dotnet-latest-build"

            echo "Login"
            az login --service-principal -u ${{ secrets.AZURE_APP_ID }} -p ${{ secrets.AZURE_PASSWORD }} --tenant ${{ secrets.AZURE_TENANT }}

            echo "Update Site Extension"
            az resource create --resource-group $resourceGroupName --resource-type "Microsoft.Web/sites/siteextensions" --name "$aasName/siteextensions/DevelopmentVerification.DdDotNet.Apm" -p "{}"

            echo "Waiting 10 seconds for extension to be actually installed"
            sleep 10

            echo "Restart Application"
            az webapp restart --resource-group $resourceGroupName --name $aasName
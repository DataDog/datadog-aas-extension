name: Update extension on AAS, triggered by dd-trace-dotnet nightly build

on:
  workflow_dispatch:
    inputs:
      sha:
        description: 'Hash commit of dd-trace-dotnet build'
        required: true
  repository_dispatch:
    types: [dd-trace-dotnet-nightly, dd-trace-code-freeze]

jobs:
  update_extension:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

    steps:
      - name: Azure CLI script
        uses: azure/CLI@v1
        with:
          inlineScript: |
            resourceGroupName="apm-aas-junkyard"
            aasName="dd-dotnet-latest-build"
            aasStatsName="dd-dotnet-latest-build-stats"
            aasProfilerOnlyName="dd-dotnet-latest-build-profiler-only"
            aasProfilerBackendName="dd-dotnet-profiler-backend-test-latest-build"

            echo "Login"
            az login --service-principal -u ${{ secrets.AZURE_APP_ID }} -p ${{ secrets.AZURE_PASSWORD }} --tenant ${{ secrets.AZURE_TENANT }}

            echo "Update Site Extensions"
            az resource create --resource-group $resourceGroupName --resource-type "Microsoft.Web/sites/siteextensions" --name "$aasName/siteextensions/DevelopmentVerification.DdDotNet.Apm" -p "{}"
            az resource create --resource-group $resourceGroupName --resource-type "Microsoft.Web/sites/siteextensions" --name "$aasStatsName/siteextensions/DevelopmentVerification.DdDotNet.Apm" -p "{}"
            az resource create --resource-group $resourceGroupName --resource-type "Microsoft.Web/sites/siteextensions" --name "$aasProfilerOnlyName/siteextensions/DevelopmentVerification.DdDotNet.Apm" -p "{}"
            az resource create --resource-group $resourceGroupName --resource-type "Microsoft.Web/sites/siteextensions" --name "$aasProfilerBackendName/siteextensions/DevelopmentVerification.DdDotNet.Apm" -p "{}"

            echo "Waiting 10 seconds for extension to be actually installed"
            sleep 10

            echo "Restart Application"
            az webapp restart --resource-group $resourceGroupName --name $aasName
            az webapp restart --resource-group $resourceGroupName --name $aasStatsName
            az webapp restart --resource-group $resourceGroupName --name $aasProfilerOnlyName
            az webapp restart --resource-group $resourceGroupName --name $aasProfilerBackendName
